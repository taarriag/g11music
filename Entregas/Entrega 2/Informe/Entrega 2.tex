\documentclass[11pt,letterpaper]{article}
\usepackage[spanish]{babel} %idioma
\usepackage[latin1]{inputenc}
\usepackage{graphicx}
\usepackage{anysize} %Permitir distintas medidas de margenes
\usepackage{array}

% Configuración PDF
\usepackage[pdftex]{hyperref}
\hypersetup{
    %bookmarks=true,
    pdfborder={0 0 0},
    pdfstartview=FitH,
    pdftitle={Arquitectura de computadores},
    pdfsubject={Entrega 2},
    pdfauthor={G11}
}

\marginsize{3cm}{2cm}{2cm}{4cm}

% $Rev: 595 $
\title{\Huge \textbf{Arquitectura de Computadores}\\\Huge \textbf{Proyecto: SmartMusic}\\\Large \textbf{Entrega 2}}
\author{Grupo G11}
\date{4 de Octubre de 2009}
\begin{document}

\maketitle

\bigskip 
\textbf{Integrantes:}
\begin{itemize}
\item Pablo Alcayaga
\item Tomás Arriagada
\item Felipe Balbontín
\item Gabriel Diéguez
\item Javier Espinoza
\item Sebastián Vicencio
\end{itemize}

\newpage
%Tabla de contenidos y figuras. Recomendamos no tocar
\tableofcontents
\listoffigures

\newpage
\section{Introducción}
En diversas ocasiones y circunstancias, se desea reproducir música. Ésta puede ser música ambiental, para acompañar una junta social, o música de algún género particular para deleitarse escuchándola. Lamentablemente, muchas veces ocurre que esta música no es la adecuada al estado de ánimo del lugar. En muchas ocasiones, el nivel de ruido disminuye, pero la música se mantiene fuerte, dificultando la comunicación. En otras, el género de la música no es el adecuado para las circunstancias. Lo anterior causa que alguien deba encargarse de controlar constantemente la reproducción musical.\\

Para solucionar el problema antes mencionado, en este proyecto semestral se desarrollará un dispositivo que controlará la reproducción musical de un computador. Este dispositivo consiste en un microcontrolador, el que estará conectado a un computador y tendrá dos sensores: uno medirá el nivel de ruido en el ambiente y el otro el nivel de luminosidad del mismo. Ambos sensores entregarán tres posibles niveles de ruido o luminosidad, lo cual genera 9 combinaciones distintas. La combinación presente en el ambiente será enviada al computador, en el cual se estará ejecutando un software diseñado para comunicarse con el dispositivo (además del software de reproducción de la música).  Éste elegirá una de entre 9 listas de reproducción distintas con su respectivo volumen, las que podrán ser configuradas por el usuario. De esta forma, el dispositivo controlará de manera automática la música reproducida en cierto lugar ajustándola a las condiciones ambientales.\\

Adicionalmente al control automático de la música, el dispositivo también permitirá comenzar y detener la reproducción junto con adelantar y retroceder de canción. Esto será a través de 3 botones puestos en el dispositivo: uno de \textit{play/pause}, uno de \textit{forward} y un último de \textit{backward}. Además, el usuario podrá programar un \textit{timer} el cual tiene el tiempo en que el dispositivo pueda iniciar o detener automáticamente la reproducción. Esto se realiza con un botón, el cual al oprimirlo una vez, incrementará el tiempo de espera en una cantidad predefinida. \emph{Si se mantiene el botón oprimido por más de 3 segundos, se reestablecerá el tiempo de espera a 0}. Por último, el dispositivo posee una pantalla LCD la cual permitirá mostrar el nombre de la canción reproducida, en conjunto con el tiempo actual del \textit{timer}.\\

Los requerimientos mínimos que debe cumplir el dispositivo son los siguientes:
\begin{itemize}
	\item Entradas y salidas digitales (DIO), para comunicarse con otros componentes digitales.
	\item Entrada análoga: para comunicarse con un sensor análogo.
	\item Comunicación bajo algún protocolo standard e.g. RS232, USB, I2C.
	\item Módulo ADC/PWM: para convertir la señal entregada por el sensor análogo y utilizarla en el dispositivo.
	\item Interrupciones programables.
	\item \textit{Timer} interno programable.
\end{itemize}

%describir el dispositivo que estamos haciendo(juntar los primeros parrafos de nuestro informe pasado)\\
%describir lo que hicimos en esta entrega(el diseño y todo eso, pero por encima, después se profundiza en este informe)\\
%describir las exigencias para el circuito (o sea poner la lista que aparece en el enunciado que tiene que es lo que debe hacer nuestro circuito: entradas análoga, interrupciones, el pic, etc)\\

\section{Diseño del dispositivo}
En esta sección se describirá el circuito que hace posible el funcionamiento de nuestro sistema. Este dispositivo consiste en una placa controladora conectada a componentes que permiten sensar el ambiente, a elementos de interfaz de usuario y a un computador.
%introducción a esta parte, cuales son los componentes a conectar. y su funcionalidad\\


\subsection{Componentes utilizados}
Los componentes utilizados se presentarán en la siguiente tabla.

\begin{table}[h]
	\begin{center}
	\begin{tabular}{|c|p{2.0cm}|p{2.0cm}|p{6.0cm}|}
		\hline  Nombre & Código  & Detalles & Uso \\ 
		\hline  Microcontrolador PIC & PIC16F877A & \href{http://ww1.microchip.com/downloads/en/DeviceDoc/39582b.pdf}{datasheet} & Permite ejecutar las instrucciones asociadas a cambios en la luminosidad, el ruido del ambiente y el input del usuario.\\
		\hline MAX232 & MAX232 & \href{http://www.datasheetcatalog.org/datasheet/texasinstruments/max232.pdf}{datasheet} & Permite conectar el PIC con el puerto serial.\\
		\hline  16x2 Character LCD & \underline{\textbf{Pantalla:}} GDM1602K. \underline{\textbf{Interfaz:}} HD44780 & \underline{\textbf{Pantalla:}} \href{http://www.olimex.cl/pdf/LCD/GDM1602K.pdf}{datasheet} \underline{\textbf{Interfaz:}} \href{http://www.olimex.cl/pdf/LCD/HD44780.pdf}{datasheet} & Muestra información de la canción actual y del estado del \textit{timer}. Se conecta a través del chip HD44780 el cual simplifica la interfaz.  \\

		\hline  Sensor de Luz & ZX-LDR & \href{http://www.olimex.cl/pdf/ZX-LDR.pdf}{datasheet} & Detecta los niveles de luminosidad del ambiente. \\ 

		\hline  Sensor de sonidos & ZX-Sound & \href{http://www.olimex.cl/pdf/INEX/ZX-sound_e.pdf}{datasheet} & Detecta el nivel de ruido ambiental. \\
		\hline  Pulsadores & SP-1116 & - & Botones de \textsl{play/pause, backward, forward, timer}. \\
		\hline
	
	\end{tabular}
	\end{center}
\end{table}


\subsection{Diagrama del circuito}
Se presentará el diseño del circuito en dos diagramas. Primero se muestra el diagrama de la placa controladora con todas las conexiones posibles (Figura: \ref{fig:PIC}). Luego se muestra un segundo diagrama con las conexiones de los dispositivos externos a la placa (Figura: \ref{fig:SmartMusic}). No se mostraron ambos diseños en el mismo diagrama por motivos de orden. Es importante recalcar que las dos entradas análogas (sensores de sonido y luminosidad) son representadas por dos potenciómetros por motivos de simulación. Esto se puede hacer ya que ambos sensores entregan un voltaje de entre 0V y 5V (como será explicado en la sección de implementación), al igual que un potenciómetro.

\begin{figure}[h]
	\centering
		\includegraphics[width=0.9\textwidth]{../Diagramas/PIC.pdf}
	\caption{Diagrama de Placa Controladora}
	\label{fig:PIC}
\end{figure}

\begin{figure}[h]
	\centering
		\includegraphics[width=0.9\textwidth]{../Diagramas/SmartMusic.pdf}
	\caption{Diagrama Conexiones Externas}
	\label{fig:SmartMusic}
\end{figure}

%explicar los diagramas. señalar que se tiene el diagrama de la placa controladora, con todas las conexiones y de manera independiente se tiene otro diagrama con las conexiones que vamos a implementar (osea, en el otro diagrama no tenemos las conexiones del pic a implementar).

\newpage

\subsection{Implementación del dispositivo}
A continuación se explicará como se conectarán los distintos dispositivos, su configuración y la forma en que serán utilizados. 

%línea introductoria\\

%en esta parte, al describir el dispositivo asociado a uno de los requisitos (PWM, entrada analoga, interrupción) describir cómo esta satisface al requisito\\

\subsubsection{Dispositivos análogos}
Nuestro sistema utiliza dispositivos análogos para capturar información del ambiente; en particular, las intensidades sonora y lumínica. Estos dispositivos generan un voltaje cuyo valor fluctúa entre 0V y 5V, representando la intensidad capturada. Posteriormente, esta intensidad es convertida a un valor entre 0 y 127 (decimal) utilizando el módulo ADC del PIC.\\

Para realizar la conversión análogo/digital se deben configurar los registros ADCON0 y ADCON1 del PIC. El primero controla el módulo conversor análogo a digital A/D y el segundo configura las funciones de los pines del puerto A (para utilizarlos como análogo o digital). La configuración debe permitir que se reciba primero el voltaje correspondiente a la intensidad sonora para luego convertirlo a binario y almacenarlo en memoria. Posteriormente se repite el proceso para la intensidad lumínica. En este caso, el registro ADCON1 indica que los pines donde se capturan las intensidades deben ser de lectura análoga y el registro ADCON0 coordinará el proceso de conversión, indicando cual es el pin sobre el cual se realizará la conversión y la señal de inicio para ésta.\\
\\
Los dispositivos análogos a utilizar son:  

\begin{enumerate}

\item \textbf{Sensor de sonido (\emph{ZX-Sound})}
	
	\begin{itemize}
		\item Código: ZX-Sound
		\item Descripción: Este dispositivo detecta la intensidad sonora del ambiente y genera un voltaje correspondiente cuyo valor fluctúa entre 0V y 5V.
		\item Requisitos asociados: ADC/PWM para la conversión analógica digital del voltaje entregado por el componente.
		\item Conexión al PIC: Puerto AN0 para leer el voltaje generado desde el componente.
	\end{itemize}


\item \textbf{Sensor de luminosidad (\emph{ZX-LDR})}

	\begin{itemize}
		\item Código: ZX-LDR
		\item Descripción: Este dispositivo detecta la intensidad lumínica del ambiente y genera un voltaje correspondiente cuyo valor fluctúa entre 0V y 5V.
		\item Requisitos asociados: ADC/PWM para la conversión analógica digital del voltaje entregado por el componente.
		\item Conexión al PIC: Puerto AN1 para leer el voltaje generado desde el componente.
	\end{itemize}

\end{enumerate}	
	
	En base al valor convertido de las intensidades se han definido tres niveles de intensidad\footnote{Estos valores están sujetos a cambios futuros al calibrar los dispositivos.}:
	\begin{itemize}
		\item Baja: Entre 0 y 42
		\item Media: Entre 42 y 85
		\item Alta: Entre 85 y 127
	\end{itemize} 
	
	Tal como se mencionó anteriormente, estos niveles permiten al sistema decidir cuál es la siguiente lista de reproducción y el volumen de ésta. 
	
\subsubsection{\textsl{Display} LCD}
	\begin{itemize}
		\item Código: GDM1602K
		\item Descripción: Display de 16 x 2 caracteres (2 líneas de hasta 16 caracteres). Dispone de once pines para la comunicación con el PIC y utiliza el chip HD44780 para su configuración y escritura.
		\item Requisitos asociados: Entrada/Salida DIO Bidireccional. PIC envía instrucciones al \textsl{display} y éste a su vez notifica a través del RS/Flag al PIC acerca de la completitud de la instrucción.
		\item Conexión al PIC: Pines del \textsl{display} (D7,D6,D5,D4,RS,RW,E) conectados al Puerto D del PIC (RD7,RD6,RD5,RD4,RD3,RD2,RD1).
	\end{itemize}
                                                                                                                                                        
Este dispositivo es utilizado con el fin de mostrar información sobre la canción actual que se está reproduciendo en el computador conectado al dispositivo. Además indica el valor actual del \textsl{timer} que permite detener o iniciar automáticamente la reproducción de música.\\
                                                                                                                       
Este \textsl{display} posee once pines configuración: RS/Flag, Read/Write, Enable y Datos (D0 A D7). De todas formas ofrece la posibilidad de ser configurado y utilizado haciendo uso de siete pines, para lo cual es necesario enviar dos valores consecutivos por instrucción. En particular, hemos optado por la segunda opción a fin de utilizar una menor cantidad de pines en el PIC, y porque no teníamos la cantidad suficiente de pines en un mismo puerto para enviar la instrucción completa (de 11 bits de largo). Las palabras de operación serán enviadas desde el Puerto D del PIC, para lo cual debemos configurar el registro TRISD de tal forma que los pines RD4, RD5, RD6 Y RD7 sean de salida digital.\\

El proceso de escritura es guiado por las instrucciones enviadas desde el PIC y consiste en la siguiente secuencia:
	\begin{enumerate}
		\item Inicializar el \textsl{display}, conectándolo a la fuente de voltaje y activando \textsl{Enable}.
		\item Configurar el \textsl{display} para recibir operaciones de 4 bits y utilizar ambas líneas. 
		\item Prender el cursor e iniciar el modo bajo el cual éste se mueve automáticamente cada vez que se escribe una instrucción en la memoria DDRAM. En la práctica, esto es cada vez que ingresamos la instrucción para escribir un caracter.
		\item Escribir datos en la memoria DDRAM. Este es el paso en el cual indicamos el caracter a imprimir en pantalla.
		\item Continuar escribiendo datos hasta completar la línea y saltar a la siguiente línea.
		\item Continuar escribiendo hasta terminar de imprimir el nombre de la canción y el estado del timer.
		\item Resetear el cursor, indicándole que vuelva a la posición inicial (a fin de sobreescribir los datos mostrados en pantalla cuando cambie la canción)	
	\end{enumerate}
	
\subsubsection{Pulsadores}
	\begin{itemize}
		\item Descripción: Botones que entregan un voltaje alto (5V) cuando detectan una pulsación.
		\item Requisitos asociados: Entrada DIO en el PIC e interrupciones.
		\item Conexión al PIC: Los cuatro botones a utilizar están conectados a pines del puerto B, cuyos cambios puede ser detectados para lanzar una interrupción (RB4, RB5, RB6 Y RB7)
	\end{itemize}
	
Nuestro sistema utiliza cuatro pulsadores (\textsl{pushbuttons}) para controlar la reproducción de música y el timer del dispositivo: \textsl{play/pause, backward, forward, timer}. Cada vez que uno de estos es pulsado, se envía un voltaje positivo al PIC. Para leer estas señales como una entrada digital, se debe configurar el registro TRISB de tal forma que los pines asociados a los botones sean de \textsl{input} digital.\\

Además de leer el Puerto B como entradas digitales, se deben activar las interrupciones al pulsarse un botón. Para ésto configuramos el registro INTCON indicándole que permita realizar interrupciones (activando el bit GIE de INTCON) y que éstas ocurran cada vez que se detectan cambios en los pines RB4 a RB7 (activando el bit RBIE de INTCON).\\

Cada vez que el usuario pulse un botón, se ejecutará una interrupción la cual deberá llevar a la ejecución de una subrutina. Esta subrutina se encarga de leer cuál fue el botón pulsado y en función de éste determina la próxima acción del sistema (Iniciar/Detener, Próxima canción, Canción anterior, Activar \textsl{Timer}). En caso de que se pulse el botón de Activar \textsl{Timer}, se deberá habilitar la interrupción de Timer (activando el bit TOIE de INTCON) y en la subrutina se deberá asignar el tiempo en el cual se activará la interrupción. El tiempo se determina a partir de la cantidad de veces que el usuario pulsó el botón de Activar Timer (por cada pulsación se incrementa el tiempo en una cantidad predefinida). Después de cierta cantidad de pulsaciones se deshabilitará la interrupción de Timer, a fin de que el sistema no cambie su estado actual transcurrido cierto tiempo (es decir, no se iniciará/detendrá automáticamente la reproducción de música).\\

\subsubsection{PIC}
	\begin{itemize}
		\item Código: PIC16F877A 
		%\item Procesador:  
		\item Timers:	2 x 8-bit, 1 x 16-bit
 		\item ADC: 8 ch, 10-bit
 		\item Cristal (externo) de 20 Mhz
	\end{itemize}
	
	Permite controlar los diferentes componentes que componen el sistema. La forma en que será utilizado ha sido explicada en la descripción de la implementación y uso de los diferentes componentes.
	
	
%-----------------------------------------
% Max232 y Serial
%-----------------------------------------
\subsubsection{MAX232 y Conexión Serial}
\begin{itemize}
		\item Descripción: El MAX232 tiene como función convertir las señales del puerto serial RS-232 a TTL para ser usadas por el PIC y viceversa. Tiene 16 pines que pueden verse en la figura \ref{fig:Max232}.
		\item Requisitos asociados: Comunicación bidireccional con PC.
		\item Conexión al PIC: Pines T1IN y R2OUT del MAX232 a los pines RC6 y RC7 del PIC respectivamente (ver cuadro 1).
	\end{itemize}
	
El puerto serial se usará tanto para cargar nuestro programa, como para comunicarnos con el PC para enviar la información del nivel de reproducción actual y para recibir el título de la canción. Para el detalle de conexión de todos sus pines, ver cuadro 1.
%-----------------------------------------
\begin{figure}
	\centering
		\includegraphics[width=0.30\textwidth]{Images/Max232.PNG}
	\caption{Diagrama del Max232}
	\label{fig:Max232}
\end{figure}
%-----------------------------------------
\begin{table}
\begin{center}
\label{tbl:pinesmax232}
\begin{tabular}{|c|p{5cm}|c|}
\hline Pin & Descripción & Conexión\\
\hline C1+ & Conexion a un condensador necesaria para su funcionamiento & C1- \\ 
\hline VS+ & Voltaje de salida positivo (-15~-0.3[V]). Se conecta un condensador (1uF) & Tierra \\ 
\hline C1- & Conexion a un condensador (1uF) necesaria para su funcionamiento & C1+ \\ 
\hline C2+ & Conexion a un condensador (1uF) necesaria para su funcionamiento & C2- \\ 
\hline C2- & Conexion a un condensador (1uF) necesaria para su funcionamiento & C2+ \\ 
\hline VS- & Voltaje de salida negativo (-0.3~15[V]) Se conecta un condensador (1uF) & Tierra \\ 
\hline T2OUT & Salida EIA-232 & No Conectado \\ 
\hline R2IN & Entrada EIA-232 2 & No Conectado \\ 
\hline R2OUT & Salida TTL/CMOS & No Conectado\\ 
\hline T2IN & Entrada TTL/CMOS & No Conectado\\ 
\hline T1IN & Entrada TTL/CMOS & Pic16F877A (RC6)\\ 
\hline R1OUT & Salida TTL/CMOS  & Pic16F877A (RC7)\\ 
\hline R1IN & Entrada EIA-232 1 & Puerto serial \\ 
\hline T1OUT & Salida EIA-232 & Puerto serial \\ 
\hline GND & Cable a tierra & Tierra \\ 
\hline Vcc & Entrada de corriente continua. Entre 4.5 y 5.5 [V] & Fuente de poder \\ 
\hline 
\end{tabular} 
\end{center}
\caption{Descripción de los pines max232}
\end{table}
%----------------------------------------
% Elementos Adicionales
%----------------------------------------
\subsubsection{Elementos Adicionales}
\begin{description}
	\item[Regulador de voltaje] El regulador de voltaje nos permite mantener un voltaje controlado para los componentes. 
\end{description}
%poner el regulador del voltaje, algún pin no conectado al pic, etc, muy corto, una línea\\

\section{Anexos}
\subsection{Anexo 1: Diagrama de flujo circuito LEDs}
\begin{figure}[h]
	\centering
		\includegraphics[width=0.90\textwidth]{Images/Flujoentrega2.png}
	\caption{Diagrama de flujo LEDs}
	\label{fig:Flujoentrega2}
\end{figure}
\end{document}